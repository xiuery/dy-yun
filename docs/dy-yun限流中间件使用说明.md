# é™æµä¸­é—´ä»¶ä½¿ç”¨è¯´æ˜

## ğŸ“‹ åŠŸèƒ½ç‰¹æ€§

- âœ… **æ»‘åŠ¨çª—å£ç®—æ³•**ï¼šç²¾ç¡®æ§åˆ¶è¯·æ±‚é¢‘ç‡
- âœ… **å¤šå­˜å‚¨æ”¯æŒ**ï¼šå†…å­˜ï¼ˆå•æœºï¼‰/ Redisï¼ˆåˆ†å¸ƒå¼ï¼‰
- âœ… **æ™ºèƒ½æ ‡è¯†**ï¼šè‡ªåŠ¨è¯†åˆ«ç”¨æˆ·IDæˆ–IPåœ°å€
- âœ… **å‹å¥½æç¤º**ï¼šè¿”å› 429 çŠ¶æ€ç å’Œ Retry-After å¤´
- âœ… **å“åº”å¤´ä¿¡æ¯**ï¼šX-RateLimit-Limit å’Œ X-RateLimit-Window

## ğŸ”§ é…ç½®è¯´æ˜

### settings.yamlï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
```yaml
rate_limit:
  enabled: true          # æ˜¯å¦å¯ç”¨é™æµ
  requests: 100          # 60ç§’å†…æœ€å¤š100æ¬¡è¯·æ±‚
  window: 60             # æ—¶é—´çª—å£60ç§’
  use_redis: false       # ä½¿ç”¨å†…å­˜å­˜å‚¨ï¼ˆå•æœºï¼‰
```

### settings.dev.yamlï¼ˆå¼€å‘ç¯å¢ƒï¼‰
```yaml
rate_limit:
  enabled: true          # æ˜¯å¦å¯ç”¨é™æµ
  requests: 200          # å¼€å‘ç¯å¢ƒæ›´å®½æ¾
  window: 60             # æ—¶é—´çª—å£60ç§’
  use_redis: true        # ä½¿ç”¨Rediså­˜å‚¨ï¼ˆåˆ†å¸ƒå¼ï¼‰
```

## ğŸ¯ å·¥ä½œåŸç†

### 1. å®¢æˆ·ç«¯è¯†åˆ«ç­–ç•¥
ä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼š
1. **ç”¨æˆ·ID** (request.state.user_id) - å·²è®¤è¯ç”¨æˆ·
2. **X-Forwarded-For** - ä»£ç†/è´Ÿè½½å‡è¡¡ç¯å¢ƒ
3. **X-Real-IP** - Nginxç­‰åå‘ä»£ç†
4. **request.client.host** - ç›´è¿IP

### 2. é™æµç®—æ³•
ä½¿ç”¨**æ»‘åŠ¨çª—å£**ç®—æ³•ï¼š
- è®°å½•æ¯æ¬¡è¯·æ±‚çš„æ—¶é—´æˆ³
- åªç»Ÿè®¡æ—¶é—´çª—å£å†…çš„è¯·æ±‚
- è¶…è¿‡é™åˆ¶è¿”å› 429 çŠ¶æ€ç 

### 3. å­˜å‚¨æ–¹å¼

#### å†…å­˜æ¨¡å¼ (use_redis: false)
- é€‚åˆï¼šå•æœºéƒ¨ç½²
- æ•°æ®ç»“æ„ï¼š`{client_id: [timestamp1, timestamp2, ...]}`
- ä¼˜ç‚¹ï¼šå¿«é€Ÿã€æ— ä¾èµ–
- ç¼ºç‚¹ï¼šä¸æ”¯æŒåˆ†å¸ƒå¼

#### Redisæ¨¡å¼ (use_redis: true)
- é€‚åˆï¼šåˆ†å¸ƒå¼/å¤šå®ä¾‹éƒ¨ç½²
- æ•°æ®ç»“æ„ï¼šRedis Sorted Set
- ä¼˜ç‚¹ï¼šè·¨å®ä¾‹å…±äº«ã€è‡ªåŠ¨è¿‡æœŸ
- ç¼ºç‚¹ï¼šä¾èµ–RedisæœåŠ¡

## ğŸ“Š å“åº”æ ¼å¼

### æˆåŠŸè¯·æ±‚ (200 OK)
```http
HTTP/1.1 200 OK
X-RateLimit-Limit: 100
X-RateLimit-Window: 60
```

### é™æµæ‹¦æˆª (429 Too Many Requests)
```json
{
  "detail": {
    "code": 429,
    "message": "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•",
    "retry_after": 30
  }
}
```

```http
HTTP/1.1 429 Too Many Requests
Retry-After: 30
```

## ğŸ§ª æµ‹è¯•æ–¹æ³•

### 1. å¯åŠ¨åº”ç”¨
```bash
# å¼€å‘ç¯å¢ƒï¼ˆ200æ¬¡/åˆ†é’Ÿï¼Œä½¿ç”¨Redisï¼‰
python main.py -c config/settings.dev.yaml
```

### 2. è¿è¡Œæµ‹è¯•è„šæœ¬
```bash
python test_rate_limit.py
```

### 3. æ‰‹åŠ¨æµ‹è¯•
```bash
# å¿«é€Ÿå‘é€å¤šæ¬¡è¯·æ±‚
for i in {1..150}; do curl http://localhost:8001/health; done
```

## ğŸ” æ—¥å¿—ç¤ºä¾‹

```
2026-01-26 14:30:15 | INFO     | common.middleware.logger:logger_middleware:14 - â†’ GET /health
2026-01-26 14:30:15 | WARNING  | common.middleware.rate_limit:rate_limit_middleware:164 - Rate limit exceeded: ip:127.0.0.1 GET /health
```

## ğŸ¨ è‡ªå®šä¹‰é…ç½®

### ä¸åŒè·¯ç”±ä¸åŒé™æµ
å¯ä»¥åœ¨è·¯ç”±çº§åˆ«æ·»åŠ è£…é¥°å™¨ï¼ˆéœ€æ‰©å±•åŠŸèƒ½ï¼‰ï¼š
```python
@router.get("/api/sensitive", dependencies=[Depends(rate_limit(10, 60))])
```

### ç™½åå•IP
åœ¨ä¸­é—´ä»¶ä¸­æ·»åŠ åˆ¤æ–­ï¼š
```python
whitelist_ips = ["10.0.0.1", "192.168.1.1"]
if client_id.split(":")[1] in whitelist_ips:
    return await call_next(request)
```

## ğŸ“ˆ æ€§èƒ½å»ºè®®

1. **ç”Ÿäº§ç¯å¢ƒå»ºè®®**ï¼šä½¿ç”¨Rediså­˜å‚¨ (use_redis: true)
2. **åˆç†è®¾ç½®é™åˆ¶**ï¼šæ ¹æ®ä¸šåŠ¡åœºæ™¯è°ƒæ•´ requests å’Œ window
3. **ç›‘æ§å‘Šè­¦**ï¼šè®°å½•é™æµæ—¥å¿—ï¼Œåˆ†æå¼‚å¸¸æµé‡
4. **é™çº§ç­–ç•¥**ï¼šRedisæ•…éšœæ—¶è‡ªåŠ¨å›é€€åˆ°å†…å­˜æ¨¡å¼

## ğŸš€ éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] ç¡®è®¤ Redis æœåŠ¡å¯ç”¨ï¼ˆå¦‚ä½¿ç”¨ Redis æ¨¡å¼ï¼‰
- [ ] æ ¹æ®ä¸šåŠ¡è®¾ç½®åˆç†çš„ requests å’Œ window
- [ ] æµ‹è¯•é™æµåŠŸèƒ½æ˜¯å¦ç”Ÿæ•ˆ
- [ ] é…ç½®æ—¥å¿—ç›‘æ§å‘Šè­¦
- [ ] å‡†å¤‡é™æµå“åº”çš„å‰ç«¯å¤„ç†é€»è¾‘
